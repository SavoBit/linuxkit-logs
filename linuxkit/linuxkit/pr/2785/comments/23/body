Took some time to figure out what this is doing. I do have some comments, but they are mostly stylistic, so I will wait for the responses from the others involved.

A few inline, though.